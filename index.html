<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>教練管理系統 - 專業全功能優化版</title>
    <!-- CSS & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        [v-cloak] { display: none !important; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; text-align: left; -webkit-tap-highlight-color: transparent; }
        
        .main-container { width: 100%; max-width: 100%; margin: 0 auto; padding-left: 0.25rem; padding-right: 0.25rem; }
        @media (min-width: 640px) { .main-container { padding-left: 1.5rem; padding-right: 1.5rem; } }
        @media (min-width: 1024px) { .main-container { padding-left: 2.5rem; padding-right: 2.5rem; } }
        
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); touch-action: pan-y; }
        
        .course-item-compact { 
            display: flex; 
            justify-content: flex-start; 
            align-items: center; 
            gap: 2px; 
            padding: 3px 6px; 
            border-radius: 6px; 
            font-size: 9px; 
            font-weight: 800; 
            margin-bottom: 3px; 
            border: 1px solid rgba(0, 0, 0, 0.15); 
            border-left-width: 4px; 
            border-style: solid;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            cursor: pointer;
            transition: transform 0.1s;
        }
        @media (min-width: 768px) {
            .course-item-compact { padding: 4px 8px; border-radius: 8px; font-size: 11px; margin-bottom: 4px; border-left-width: 5px; gap: 4px; }
        }
        .course-item-compact:active { transform: scale(0.97); }

        .action-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 20px; background-color: #4f46e5; color: white !important; border-radius: 1.25rem; font-weight: 800; box-shadow: 0 4px 12px -2px rgba(79, 70, 229, 0.4); transition: all 0.2s ease; cursor: pointer; }
        
        .available-time-text { 
            font-size: 13px; 
            line-height: 1.8; 
            color: #4f46e5; 
            text-align: center; 
            font-weight: 800; 
            padding: 10px 0; 
            border-radius: 12px; 
            transition: all 0.2s; 
            cursor: pointer; 
            border: 1px solid #e2e8f0; 
            background: white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .available-time-text:hover { background-color: #4f46e5; color: white; border-color: #4f46e5; transform: translateY(-1px); }
        
        .sync-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 9999px; font-size: 10px; font-weight: 900; background: white; border: 1px solid #e2e8f0; color: #64748b; }
        .sync-pill.synced { color: #10b981; border-color: #10b981; background: #f0fdf4; }
        .sync-pill.syncing { color: #4f46e5; border-color: #4f46e5; }
        .animate-spin-custom { animation: spin 1.5s linear infinite; }
        
        .week-scroll-container { display: flex; overflow-x: auto; gap: 6px; padding-bottom: 12px; scroll-snap-type: x mandatory; }
        .week-column { min-width: 140px; flex: 1; scroll-snap-align: start; }
        @media (min-width: 1024px) { 
            .week-scroll-container { display: grid; grid-template-columns: repeat(7, 1fr); overflow-x: visible; gap: 8px; } 
            .week-column { min-width: 0; }
        }
        
        .status-pill { padding: 4px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; background: white; color: #64748b; }
        .status-pill-active { background-color: #10b981; color: white; border-color: #10b981; }

        .progress-btn { font-size: 9px; font-weight: 900; padding: 6px 12px; border-radius: 10px; border: 1px solid #f1f5f9; background: #f8fafc; color: #94a3b8; transition: all 0.2s; }
        .progress-btn-active { background: #475569; color: white; border-color: #475569; }

        .view-tab-btn { padding: 10px 20px; font-size: 13px; font-weight: 900; border-radius: 12px; transition: all 0.3s; color: #64748b; border: 1px solid transparent; }
        .view-tab-btn-active { background: white; color: #4f46e5; border-color: #e2e8f0; box-shadow: 0 4px 12px -2px rgba(0,0,0,0.08); }

        .renewal-input { width: 70px; font-size: 12px; font-weight: 900; padding: 4px 6px; border-radius: 6px; border: 2px solid #f1f5f9; text-align: center; }
        .name-remark-tag { background-color: #ecfdf5; color: #059669; padding: 1px 5px; border-radius: 4px; font-size: 9px; font-weight: 900; border: 1px solid #10b981; margin-left: 4px; display: inline-flex; align-items: center; vertical-align: middle; }
        .type-chip { background-color: #f5f3ff; color: #7c3aed; padding: 2px 8px; border-radius: 6px; font-size: 9px; font-weight: 900; display: inline-block; border: 1px solid #ddd6fe; }

        .attendance-record-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f8fafc; border-radius: 12px; border: 1px solid #f1f5f9; margin-bottom: 8px; }
        .status-badge-small { font-size: 9px; font-weight: 900; padding: 2px 8px; border-radius: 6px; }
        .custom-checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #e2e8f0; appearance: none; cursor: pointer; transition: all 0.2s; position: relative; flex-shrink: 0; background: white; }
        .custom-checkbox:checked { background: #10b981; border-color: #10b981; }
        .custom-checkbox:checked::after { content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 14px; font-weight: bold; }

        .nav-arrow-btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 36px; 
            height: 36px; 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 10px; 
            color: #64748b;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .nav-arrow-btn:hover { background: #f8fafc; color: #4f46e5; border-color: #4f46e5; transform: scale(1.05); }

        .copyright-overlay {
            position: fixed;
            bottom: 90px;
            right: 20px;
            font-size: 10px;
            font-weight: 900;
            color: #64748b;
            opacity: 0.3;
            pointer-events: none;
            z-index: 30;
            user-select: none;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body class="overflow-x-hidden text-slate-800 text-left">
    <div id="app" v-cloak class="min-h-screen pb-32 pt-2 sm:pt-4 text-left">
        
        <!-- 版權字樣 -->
        <div class="copyright-overlay">@Lechechen</div>

        <!-- 底部導覽列 -->
        <div class="fixed bottom-4 sm:bottom-6 left-1/2 -translate-x-1/2 z-40 w-[96%] sm:w-auto">
            <nav class="glass-nav rounded-[2rem] px-1 sm:px-2 py-1.5 flex items-center justify-around sm:justify-center sm:gap-1 text-left">
                <template v-if="isCoachMode">
                    <button v-for="item in navItems" :key="'nav-'+item.id" @click="activeTab = item.id"
                        class="relative flex flex-col items-center gap-1 py-2.5 px-3 sm:px-8 rounded-full transition-all duration-300"
                        :class="[activeTab === item.id ? 'text-white bg-indigo-600 shadow-lg shadow-indigo-200' : 'text-slate-400 hover:text-slate-600']">
                        <i :data-lucide="item.icon" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                        <span class="text-[9px] sm:text-[10px] font-black">{{ item.name }}</span>
                    </button>
                    <button @click="logoutCoach" class="p-2.5 text-slate-400">
                        <i data-lucide="lock-open" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    </button>
                </template>
                <template v-else>
                    <div class="px-6 sm:px-12 py-2.5 text-indigo-600 font-black text-xs sm:text-sm tracking-widest flex items-center gap-2">
                        <i data-lucide="send" class="w-4 h-4"></i> 學生預約端
                    </div>
                    <button @click="showCoachAuth = true" class="p-3 text-slate-300">
                        <i data-lucide="lock" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    </button>
                </template>
            </nav>
        </div>

        <main v-if="user" class="main-container">
            <!-- 學生預約端 -->
            <section v-if="!isCoachMode || activeTab === 'booking'" class="space-y-4 sm:space-y-6 animate-in fade-in duration-300 pb-10">
                <div class="bg-indigo-600 text-white p-6 sm:p-12 rounded-[2.5rem] sm:rounded-[3.5rem] shadow-2xl relative overflow-hidden text-left">
                    <div class="relative z-10">
                        <h2 class="text-2xl sm:text-4xl lg:text-5xl font-black mb-1">課程預約系統</h2>
                        <p class="text-indigo-100 text-[10px] sm:text-base font-bold opacity-90">雲端即時同步，選取預約時間。</p>
                    </div>
                    <i data-lucide="calendar-heart" class="absolute -right-6 -bottom-6 w-48 h-48 sm:w-96 sm:h-96 opacity-10 rotate-12"></i>
                </div>

                <div class="bg-white p-3 sm:p-10 rounded-[2.5rem] border shadow-sm space-y-4 text-left">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-3 text-left">
                        <div class="flex items-center gap-2">
                            <button @click="changeViewPeriod(-1)" class="nav-arrow-btn"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <div class="px-4 py-2 bg-slate-50 border rounded-xl text-xs lg:text-base font-black text-slate-700 min-w-[180px] text-center uppercase">{{ weekRangeLabel }}</div>
                            <button @click="changeViewPeriod(1)" class="nav-arrow-btn"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <button @click="goToToday" class="w-full sm:w-auto text-sm font-black text-indigo-600 px-8 py-3.5 bg-indigo-50/50 rounded-2xl text-center">返回本週</button>
                    </div>
                    
                    <div class="week-scroll-container">
                        <div v-for="day in currentWeekDays" :key="'s-wk-f-'+day.date" class="week-column bg-slate-50/50 rounded-[1.5rem] sm:rounded-[2.5rem] p-2 sm:p-4 flex flex-col border border-transparent transition-all" :class="{'bg-indigo-50/50 border-indigo-100 ring-2 ring-indigo-50': day.isToday}">
                            <div class="text-center py-4 mb-2 border-b border-slate-100/50">
                                <p class="text-[9px] font-black text-slate-400 uppercase mb-1">{{ day.name }}</p>
                                <p :class="['text-2xl font-black text-center', day.isToday ? 'text-indigo-600' : 'text-slate-700']">{{ day.dayNum }}</p>
                            </div>
                            <div class="space-y-2 overflow-y-auto max-h-[400px] custom-scrollbar px-0.5 pb-2 text-center">
                                <div v-if="isFullDayVacation(day.date)" class="flex flex-col items-center justify-center py-10 gap-2 opacity-60 text-red-500 font-bold text-center">
                                    <i data-lucide="coffee" class="w-5 mx-auto"></i><span class="text-[9px] font-black">休假中</span>
                                </div>
                                <div v-else-if="getAvailableSlots(day.date).length > 0" class="grid grid-cols-1 gap-2 text-center">
                                    <button v-for="slot in getAvailableSlots(day.date)" :key="'slot-v-f-'+day.date+'-'+slot" @click="triggerBooking(slot, day.date)" class="w-full available-time-text block shadow-sm text-center">{{ slot }}</button>
                                </div>
                                <div v-else class="text-center py-10 opacity-30 italic text-[9px] font-bold text-center">已滿</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 教練管理端 -->
            <template v-if="isCoachMode && activeTab !== 'booking'">
                <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4 mb-6 px-1 text-left">
                    <div class="flex flex-col text-left">
                        <h2 class="text-2xl sm:text-4xl font-black text-slate-900 leading-tight text-left">{{ pageTitle }}</h2>
                        <div :class="['sync-pill mt-2 shadow-sm font-black w-fit text-left', syncStatus === 'synced' ? 'synced' : 'syncing']">
                            <i :data-lucide="syncStatus === 'synced' ? 'cloud-check' : 'refresh-cw'" :class="['w-3 h-3', syncStatus === 'syncing' ? 'animate-spin-custom' : '']" @click="manualSync"></i>
                            <span class="text-[9px]">雲端數據對齊中</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-2 text-left">
                        <div v-if="activeTab === 'schedule'" class="flex bg-white p-1 rounded-xl border shadow-sm">
                            <button @click="calendarView = 'week'" class="px-4 py-1.5 text-[10px] font-black rounded-lg transition-all text-left" :class="[calendarView === 'week' ? 'bg-slate-900 text-white shadow-md' : 'text-slate-400']">週</button>
                            <button @click="calendarView = 'month'" class="px-4 py-1.5 text-[10px] font-black rounded-lg transition-all text-left" :class="[calendarView === 'month' ? 'bg-slate-900 text-white shadow-md' : 'text-slate-400']">月</button>
                        </div>
                        <button v-if="activeTab === 'schedule'" @click="openAddModal()" class="action-btn py-2 px-4 rounded-xl text-left"><i data-lucide="plus" class="w-4 h-4"></i><span class="text-xs">錄入行程</span></button>
                        <button v-if="activeTab === 'students'" @click="openStudentModal()" class="action-btn py-2 px-4 rounded-xl text-left"><i data-lucide="plus" class="w-4 h-4"></i><span class="text-xs text-left">新增學員</span></button>
                        <button v-if="activeTab === 'leads'" @click="openLeadModal()" class="action-btn py-2 px-4 rounded-xl text-left"><i data-lucide="user-plus" class="w-4 h-4"></i><span class="text-xs text-left">新增對象</span></button>
                    </div>
                </div>

                <!-- 1. 教練行程排程 -->
                <section v-if="activeTab === 'schedule'" class="space-y-6 animate-in fade-in duration-300">
                    <div class="bg-white p-2 sm:p-6 rounded-[2rem] sm:rounded-[3rem] border shadow-sm overflow-hidden shadow-xl w-full text-left">
                        <div class="flex items-center justify-between mb-6 px-1 text-left">
                            <div class="flex items-center gap-2">
                                <button @click="changeViewPeriod(-1)" class="nav-arrow-btn"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                <div class="px-4 py-2 bg-slate-50 border rounded-xl text-[11px] font-black text-slate-700 flex items-center gap-2 text-left">
                                    <template v-if="calendarView === 'month'">
                                        <select v-model.number="selectedYear" class="bg-transparent outline-none cursor-pointer"><option v-for="year in yearOptions" :key="'opt-yr-'+year" :value="year">{{ year }}</option></select>
                                        <select v-model.number="selectedMonth" class="bg-transparent outline-none cursor-pointer"><option v-for="(m, idx) in monthLabelsArr" :key="'opt-mon-'+idx" :value="idx">{{ m }}</option></select>
                                    </template>
                                    <template v-else>{{ weekRangeLabel }}</template>
                                </div>
                                <button @click="changeViewPeriod(1)" class="nav-arrow-btn"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            </div>
                            <button @click="goToToday" class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-4 py-2 rounded-lg transition-colors hover:bg-indigo-100">今日</button>
                        </div>
                        
                        <div v-if="calendarView === 'month'" @touchstart="handleTouchStart" @touchend="handleTouchEnd" class="overflow-x-auto custom-scrollbar pb-4">
                            <div class="min-w-[700px] lg:min-w-full text-left">
                                <div class="calendar-grid mb-1 text-center text-[9px] font-black text-slate-300 uppercase">
                                    <div v-for="w in dayNamesShort" :key="'w-header-'+w">{{ w.replace('週', '') }}</div>
                                </div>
                                <div class="calendar-grid gap-px bg-slate-100 rounded-2xl overflow-hidden border border-slate-100 shadow-inner">
                                    <div v-for="empty in viewMonthPadding" :key="'empty-v-f-'+empty" class="bg-slate-50/50 aspect-square text-left"></div>
                                    <div v-for="day in viewDaysInMonth" :key="'ch-d-f-v17-'+day.date" 
                                        @click="selectedDate = day.date; openAddModal()"
                                        class="bg-white p-1 flex flex-col cursor-pointer transition-all h-[100px] sm:h-[130px] lg:h-[160px] text-left"
                                        :class="[selectedDate === day.date ? 'ring-2 ring-inset ring-indigo-600 bg-indigo-50/10' : '']">
                                        <span class="text-[9px] sm:text-[11px] font-black mb-1" :class="[day.isToday ? 'text-indigo-600 underline' : 'text-slate-400']">{{ day.dayNum }}</span>
                                        <div class="space-y-1 overflow-auto custom-scrollbar pr-0.5 flex-1">
                                            <div v-for="course in getDayCourses(day.date)" :key="'coach-c-f-v17-m-'+course?.id"
                                                @click.stop="editCourse(course)"
                                                class="course-item-compact border text-left"
                                                :class="[(course?.student === '教練休假' || course?.student === '休假' || course?.isVacation) ? 'bg-red-50 border-red-500 text-red-700' : (course?.isWorkTask ? 'bg-amber-50 border-amber-500 text-amber-700' : (course?.status === 'cancelled' ? 'bg-slate-50 border-slate-300 opacity-40' : getLightBgClass(course?.color) + ' ' + getBorderClass(course?.color)))]">
                                                <span class="whitespace-nowrap font-black text-[11px] text-left">{{ (course?.student === '教練休假' || course?.student === '休假') ? '休假' : course?.student }}</span>
                                                <span v-if="course?.time !== '全天'" class="text-[11px] font-bold opacity-60 whitespace-nowrap text-left">{{ course?.time }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-else class="week-scroll-container">
                            <div v-for="day in currentWeekDays" :key="'coach-wk-f-v17-'+day.date" 
                                @click="selectedDate = day.date; openAddModal()"
                                class="week-column bg-white min-h-[400px] lg:min-h-[600px] p-2 sm:p-4 flex flex-col border transition-all rounded-[1.5rem] sm:rounded-[2.5rem] text-left"
                                :class="[selectedDate === day.date ? 'ring-2 ring-inset ring-indigo-600 shadow-lg' : 'border-slate-50']">
                                <div class="text-center mb-3 border-b border-slate-50 pb-2">
                                    <p class="text-slate-400 text-[9px] font-black uppercase text-center">{{ day.name }}</p>
                                    <p class="text-2xl font-black text-slate-700 text-center">{{ day.dayNum }}</p>
                                </div>
                                <div class="space-y-2 flex-1 overflow-auto custom-scrollbar text-left">
                                    <div v-for="course in getDayCourses(day.date)" :key="'cw-item-f-v17-'+course?.id"
                                        @click.stop="editCourse(course)"
                                        class="course-item-compact border p-2 sm:p-3 rounded-xl border-l-4 shadow-sm flex-col items-start gap-0 text-left"
                                        :class="[(course?.student === '教練休假' || course?.student === '休假' || course?.isVacation) ? 'bg-red-50 border-red-500 text-red-700 font-black' : (course?.isWorkTask ? 'bg-amber-50 border-amber-500 text-amber-700 font-black' : (course?.status === 'cancelled' ? 'bg-slate-50 border-slate-300 opacity-40' : getLightBgClass(course?.color) + ' ' + getBorderClass(course?.color)))]">
                                        <span class="font-black w-full whitespace-nowrap text-xs text-left">{{ (course?.student === '教練休假' || course?.student === '休假') ? '休假' : course?.student }}</span>
                                        <span class="opacity-50 font-black w-full text-xs whitespace-nowrap text-left">{{ course?.time }}</span>
                                    </div>
                                    <div v-if="getDayCourses(day.date).length === 0" class="py-12 text-center text-slate-200 italic font-black text-[9px]">無行程</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 行程總覽 -->
                    <div class="mt-6 space-y-3 px-1 text-left">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">今日及後續預約清單 (總覽)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-3">
                            <div v-for="item in upcomingSchedule" :key="'ov-f-final-v17-'+item.id" 
                                class="group p-4 rounded-2xl border shadow-sm flex items-center justify-between hover:shadow-md transition-all bg-white"
                                :class="[item.status === 'cancelled' ? 'grayscale opacity-40' : '', (item.student === '教練休假' || item.student === '休假' || item.isVacation) ? 'border-red-100' : '', item.date < todayDateStr ? 'opacity-50' : '']">
                                <div class="flex items-center gap-3">
                                    <div :class="['w-11 h-11 rounded-xl border flex flex-col items-center justify-center text-center transition-all', item.date === todayDateStr ? 'bg-indigo-600 border-indigo-600 shadow-md text-white' : 'bg-slate-50 border-slate-100']">
                                        <p :class="['text-[8px] font-black', item.date === todayDateStr ? 'text-indigo-100' : 'text-slate-400']">{{ item.date?.split('-')?.[1] }}/</p>
                                        <p :class="['text-base font-black leading-none', item.date === todayDateStr ? 'text-white' : 'text-slate-800']">{{ item.date?.split('-')?.[2] }}</p>
                                    </div>
                                    <div class="text-left">
                                        <h4 class="font-black text-sm text-left" :class="[(item.student === '教練休假' || item.student === '休假' || item.isVacation) ? 'text-red-500' : (item.isWorkTask ? 'text-amber-600' : 'text-slate-800')]">{{ (item.student === '教練休假' || item.student === '休假') ? '休假' : item.student }}</h4>
                                        <p class="text-[9px] font-bold mt-0.5 flex items-center gap-1 text-slate-400 text-left"><i data-lucide="clock" class="w-3 h-3 text-left"></i> {{ bookingTimeDisplay(item.time) }}</p>
                                        <div v-if="!item.isVacation && !item.isWorkTask" class="flex gap-1.5 mt-2">
                                            <button @click="updateCourseStatus(item.id, 'confirmed')" :class="['status-pill', item.status === 'confirmed' ? 'status-pill-active text-left' : '']">已到</button>
                                            <button @click="updateCourseStatus(item.id, 'no-show')" :class="['status-pill', item.status === 'no-show' ? 'status-pill-no-show text-left' : '']">未到</button>
                                            <button @click="updateCourseStatus(item.id, 'cancelled')" :class="['status-pill', item.status === 'cancelled' ? 'status-pill-cancelled text-left' : '']">取消</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="editCourse(item)" class="p-1.5 text-slate-300 hover:text-indigo-600 transition-colors text-left"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                    <button @click="deleteCourse(item.id)" class="p-1.5 text-slate-300 hover:text-red-500 transition-colors text-left"><i data-lucide="trash-2" class="w-3.5 h-3.5 text-left text-left"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. 學員名單 -->
                <section v-if="activeTab === 'students'" class="animate-in fade-in duration-300 pb-10 text-left">
                    <div class="flex bg-slate-100 p-1.5 rounded-xl w-fit mb-6 text-left">
                        <button @click="studentViewMode = 'active'" class="view-tab-btn" :class="[studentViewMode === 'active' ? 'view-tab-btn-active shadow-sm text-left' : '']">進行中</button>
                        <button @click="studentViewMode = 'archive'" class="view-tab-btn" :class="[studentViewMode === 'archive' ? 'view-tab-btn-active shadow-sm text-left' : '']">封存明細</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 px-1 text-left">
                        <div v-for="student in (studentViewMode === 'active' ? activeStudents : archivedStudents)" :key="'stu-f-final-'+student.id" class="bg-white p-6 rounded-[2rem] border shadow-sm flex flex-col hover:shadow-xl transition-all text-left" :class="[student.isArchived ? 'border-slate-100 opacity-80' : 'border-transparent']">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-4 text-left">
                                    <div class="w-14 h-14 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center font-black text-2xl text-center">{{ student?.name?.charAt(0) }}</div>
                                    <div class="text-left">
                                        <h3 class="font-black text-slate-800 text-lg flex items-center text-left">{{ student?.name }}<span v-if="student.source === '開發成功轉入'" class="name-remark-tag">開發轉入</span></h3>
                                        <div class="flex flex-wrap gap-1.5 mt-1.5 text-left"><span class="text-[10px] font-bold text-slate-400 uppercase text-left text-left">{{ student.isArchived ? '已結業' : '學員' }}</span><span v-if="student.studentType" class="type-chip text-[9px] text-left">{{ student.studentType }}</span></div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button @click="openAttendanceDetail(student)" class="p-2 text-indigo-400 hover:text-indigo-600 transition-colors text-left" title="出席明細"><i data-lucide="clipboard-list" class="w-5 h-5"></i></button>
                                    <button @click="editStudent(student)" class="p-2 text-slate-300 hover:text-slate-600 text-left"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                    <button @click="deleteStudent(student.id)" class="p-2 text-slate-300 hover:text-red-500 text-left"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-1 py-5 border-t text-center text-[10px] font-black">
                                <div><p class="text-slate-400 mb-1 uppercase text-center">購買</p><p class="text-sm text-center">{{ student?.totalLessons }}</p></div>
                                <div><p class="text-slate-400 mb-1 text-center">已上</p><p class="text-sm text-indigo-600 text-center">{{ getStudentStats(student?.name).used }}</p></div>
                                <div><p class="text-emerald-500 mb-1 text-center">出席%</p><p class="text-sm text-emerald-600 text-center">{{ getStudentStats(student?.name).rate }}%</p></div>
                                <div><p class="text-slate-400 mb-1 text-center">剩餘</p><p :class="[getStudentStats(student?.name).remaining <= 2 ? 'text-red-500' : 'text-slate-700']" class="text-sm text-center">{{ getStudentStats(student?.name).remaining }}</p></div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-50 space-y-4 text-left">
                                <div v-if="!student.isArchived" class="flex items-center gap-2">
                                    <input type="number" v-model.number="student.renewalLessons" placeholder="+堂" class="renewal-input">
                                    <button @click="renewStudent(student)" class="flex-1 bg-indigo-600 text-white text-[10px] font-black py-3 rounded-xl text-center">續約同步</button>
                                    <button @click="archiveStudent(student.id, true)" class="bg-slate-100 text-slate-500 text-[10px] font-black px-4 py-3 rounded-xl text-center">封存</button>
                                </div>
                                <button v-else @click="archiveStudent(student.id, false)" class="w-full bg-slate-800 text-white text-[10px] font-black py-3 rounded-xl text-center">恢復至名單</button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- 3. 開發進度 -->
                <section v-if="activeTab === 'leads'" class="space-y-6 animate-in fade-in duration-300 pb-10 text-left">
                    <div class="flex bg-slate-100 p-1.5 rounded-xl w-fit mb-6 text-left">
                        <button @click="leadViewMode = 'active'" class="view-tab-btn" :class="[leadViewMode === 'active' ? 'view-tab-btn-active shadow-sm text-left' : '']">進行中</button>
                        <button @click="leadViewMode = 'archive'" class="view-tab-btn" :class="[leadViewMode === 'archive' ? 'view-tab-btn-active shadow-sm text-left' : '']">已結案</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-4 px-1 text-left text-left">
                        <div v-for="lead in (leadViewMode === 'active' ? activeLeads : archivedLeads)" :key="'lead-f-v17-'+lead.id" class="group bg-white p-6 sm:p-8 rounded-[2rem] border-2 shadow-sm flex flex-col gap-6 hover:shadow-xl transition-all text-left" :class="[lead.status === '已開發成功' || lead.status === '成功' || lead.status === '開發成功' || lead.status === '已結案' ? 'border-emerald-100 bg-emerald-50/10 text-left' : 'border-transparent']">
                            <div class="flex items-start justify-between text-left text-left">
                                <div class="flex items-center gap-4 text-left">
                                    <input type="checkbox" :checked="lead.isCompleted" @change="toggleLeadComplete(lead)" class="custom-checkbox">
                                    <div class="text-left text-left"><h3 class="font-black text-slate-800 text-xl text-left">{{ lead?.name }}</h3><div class="space-y-1 mt-2 text-left text-left"><p v-if="lead?.phone" class="text-[9px] text-slate-400 font-bold flex items-center gap-1 text-left"><i data-lucide="phone" class="w-3 h-3 text-left"></i>{{ lead.phone }}</p><p v-if="lead?.lineMsg" class="text-[9px] text-indigo-500 font-bold flex items-center gap-1 text-left text-left"><i data-lucide="message-circle" class="w-3 h-3 text-left text-left text-left"></i>{{ lead.lineMsg }}</p></div></div>
                                </div>
                                <span class="badge px-3 py-1 font-black text-[9px] uppercase tracking-wider text-left" :class="[getLeadStatusClass(lead.status)]">{{ lead.status }}</span>
                            </div>
                            <div class="bg-white/60 rounded-2xl p-5 flex-1 border border-slate-100 text-left">
                                <div class="flex justify-between items-center mb-4 text-left">
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-left">備忘錄</p>
                                    <button @click="addProgressNote(lead)" class="text-[9px] text-indigo-600 font-black hover:underline text-left">+ 新增</button>
                                </div>
                                <div v-if="lead.notes && lead.notes.length" class="space-y-4 max-h-[150px] overflow-y-auto custom-scrollbar pr-2 text-left">
                                    <div v-for="(note, idx) in lead.notes" :key="'note-f-v17-'+idx" class="border-l-2 border-indigo-200 pl-3 text-left">
                                        <p class="text-[11px] text-slate-700 font-bold leading-relaxed text-left text-left text-left">{{ note.content }}</p>
                                        <p class="text-[8px] text-slate-400 font-bold mt-1 uppercase text-left text-left">{{ note.date }}</p>
                                    </div>
                                </div>
                                <div v-else class="text-center py-6 text-slate-300 text-[10px] font-bold italic text-center">目前尚無備忘紀錄</div>
                            </div>
                            <div class="space-y-2 pt-1 text-left text-left"><div class="flex flex-wrap gap-1.5 text-left text-left"><button v-for="st in ['待聯繫', '聯繫中', '體驗', '成功', '不考慮']" :key="'ld-st-f-v17-'+st" @click="triggerLeadStatusUpdate(lead, st === '體驗' ? '已約體驗' : st === '成功' ? '開發成功' : st === '不考慮' ? '暫不考慮' : st)" class="progress-btn text-left text-left" :class="[(lead.status === st || (st==='體驗' && lead.status==='已約體驗') || (st==='成功' && (lead.status==='已開發成功' || lead.status==='開發成功')) || (st==='不考慮' && lead.status==='暫不考慮')) ? 'progress-btn-active text-left' : '']">{{ st }}</button></div></div>
                            <div class="flex justify-end gap-1.5 pt-4 border-t border-slate-50 mt-auto text-right text-left text-left">
                                <button @click="editLead(lead)" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-indigo-600 transition-colors text-left text-left"><i data-lucide="pencil" class="w-4 h-4 text-left text-left"></i></button>
                                <button @click="deleteLead(lead.id)" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-red-500 transition-colors text-left text-left text-left"><i data-lucide="trash-2" class="w-4 h-4 text-left text-left text-left"></i></button>
                            </div>
                        </div>
                    </div>
                </section>
            </template>
        </main>

        <!-- 所有彈窗組件 -->
        
        <!-- 全域刪除確認視窗 -->
        <transition name="fade">
            <div v-if="showDeleteModal" class="fixed inset-0 z-[1000] flex items-center justify-center p-4 text-center">
                <div @click="showDeleteModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm text-center"></div>
                <div class="relative w-full max-w-sm bg-white rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 text-center text-center">
                    <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6 text-center text-center">
                        <i data-lucide="alert-triangle" class="w-8 h-8 text-center"></i>
                    </div>
                    <h3 class="text-xl font-black text-slate-900 mb-2 text-center">確認刪除？</h3>
                    <p class="text-slate-500 text-sm font-bold mb-8 leading-relaxed text-center">您確定要刪除此筆「{{ deleteTargetName }}」資料嗎？此動作將無法復原。</p>
                    <div class="flex gap-3 text-center">
                        <button @click="showDeleteModal = false" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black active:scale-95 transition-all text-center">取消</button>
                        <button @click="executeDelete()" class="flex-1 bg-red-500 text-white py-4 rounded-2xl font-black shadow-lg shadow-red-100 active:scale-95 transition-all text-center">確定刪除</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 開發對象彈窗 -->
        <transition name="fade"><div v-if="showLeadModal" class="fixed inset-0 z-[600] flex items-center justify-center p-2 text-left text-left text-left"><div @click="showLeadModal = false" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm text-left text-left text-left"></div><div class="relative w-full max-w-md bg-white rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 text-left text-left text-left"><div class="flex items-center justify-between mb-6 text-left text-left text-left"><div><h3 class="text-xl font-black text-slate-900 text-left text-left text-left">{{ isEditingLead ? '編輯對象' : '新增對象' }}</h3></div><button @click="showLeadModal = false" class="p-2 bg-slate-100 rounded-full active:scale-95 text-left text-left text-left"><i data-lucide="x" class="w-5 h-5 text-left text-left text-left"></i></button></div><div class="space-y-4 text-left text-left text-left"><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left">姓名</label><input v-model="currentLead.name" type="text" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left"></div><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left">手機號碼</label><input v-model="currentLead.phone" type="text" placeholder="手機號碼" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left"></div><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left">LINE ID / 聯繫方式</label><input v-model="currentLead.lineMsg" type="text" placeholder="LINE ID / 聯繫管道" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left"></div><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left">當前狀態</label><select v-model="currentLead.status" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-sm text-left text-left text-left"><option v-for="st in ['待聯繫', '聯繫中', '體驗', '成功', '不考慮']" :key="'opt-st-v20-opt-'+st" :value="st">{{ st }}</option></select></div><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left">購買總堂數 (轉入學員用)</label><input v-model.number="currentLead.purchasedLessons" type="number" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left"></div><button @click="saveLead" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition-all text-center text-center text-center">確認存檔</button></div></div></div></transition>

        <!-- 管理員驗證 -->
        <transition name="fade"><div v-if="showCoachAuth" class="fixed inset-0 z-[500] flex items-center justify-center p-4 text-center text-left text-left text-left"><div @click="showCoachAuth = false" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm text-center"></div><div class="relative bg-white p-10 rounded-[3.5rem] shadow-2xl max-w-sm w-full text-center"><h3 class="text-xl font-black mb-8 text-slate-900 text-center">管理員登入</h3><input v-model="coachPass" type="password" placeholder="管理密碼" class="w-full bg-slate-100 border-none rounded-2xl py-5 px-6 mb-8 text-center font-black text-xl focus:ring-2 focus:ring-indigo-600 text-slate-900 text-center"><div class="flex gap-4 text-center"><button @click="verifyCoach" class="flex-1 bg-slate-900 text-white py-5 rounded-2xl font-black active:scale-95 transition-all text-center">確認</button><button @click="showCoachAuth = false" class="px-6 text-slate-400 font-bold text-center">取消</button></div></div></div></transition>

        <!-- 錄入行程彈窗 -->
        <transition name="fade"><div v-if="showAddModal" class="fixed inset-0 z-[550] flex items-center justify-center p-2 text-left text-left text-left"><div @click="showAddModal = false" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm text-left text-left text-left"></div><div class="relative w-full max-md bg-white rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 text-left text-left text-left text-left"><div class="flex items-center justify-between mb-6 text-left text-left text-left text-left"><div><h3 class="text-xl font-black text-slate-900 text-left text-left text-left">錄入行程</h3></div><button @click="showAddModal = false" class="p-2 bg-slate-100 rounded-full active:scale-95 text-left text-left text-left text-left text-left text-left text-left"><i data-lucide="x" class="w-6 h-6 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"></i></button></div><div class="space-y-5 text-left text-left text-left text-left text-left text-left text-left text-left"><div class="flex bg-slate-100 p-1.5 rounded-xl text-left text-left text-left text-left text-left text-left text-left text-left"><button @click="newCourse.isVacation = false; newCourse.isWorkTask = false" class="flex-1 py-2.5 rounded-lg text-[11px] font-black transition-all text-center text-center text-center text-center text-center text-center text-center text-center" :class="[(!newCourse.isVacation && !newCourse.isWorkTask) ? 'bg-white shadow-sm text-slate-900 text-center' : 'text-slate-400 text-center']">學生課程</button><button @click="newCourse.isVacation = false; newCourse.isWorkTask = true" class="flex-1 py-2.5 rounded-lg text-[11px] font-black transition-all text-center text-center text-center text-center text-center text-center text-center text-center" :class="[newCourse.isWorkTask ? 'bg-white shadow-sm text-amber-600 text-center' : 'text-slate-400 text-center']">行程</button><button @click="newCourse.isVacation = true; newCourse.isWorkTask = false" class="flex-1 py-2.5 rounded-lg text-[11px] font-black transition-all text-center text-center text-center text-center text-center text-center text-center text-center" :class="[newCourse.isVacation ? 'bg-white shadow-sm text-red-600 text-center' : 'text-slate-400 text-center']">休假</button></div><div v-if="!newCourse.isVacation" class="text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"> <label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left text-left text-left text-left text-left">姓名/內容</label><input v-model="newCourse.student" type="text" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left text-left text-left text-left text-left text-left"> </div><div class="grid grid-cols-2 gap-4 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"> <div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left text-left text-left text-left text-left text-left text-left">日期</label><input v-model="newCourse.date" type="date" class="w-full bg-slate-100 border-none rounded-xl py-4 px-3 font-black text-xs text-left text-left text-left text-left text-left text-left text-left text-left text-left"></div><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left text-left text-left text-left text-left text-left text-left">時段</label><div class="flex items-center gap-1 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><select v-model="newCourse.time" class="flex-1 bg-slate-100 border-none rounded-xl py-4 px-2 font-black text-xs text-left text-left text-left text-left text-left text-left text-left text-left text-left"><option value="全天">全天</option><option v-for="slot in availableSlotsRaw" :key="'slot-s-v17-v2-'+slot" :value="slot">{{ slot }}</option></select><template v-if="newCourse.time !== '全天'"><span class="text-slate-300 font-bold text-left text-left text-left text-left text-left text-left text-left text-left text-left">~</span><select v-model="newCourse.endTime" class="flex-1 bg-slate-100 border-none rounded-xl py-4 px-2 font-black text-xs text-left text-left text-left text-left text-left text-left text-left text-left text-left"><option v-for="slot in availableSlotsRaw.filter(s => toMin(s) > toMin(newCourse.time))" :key="'slot-e-v17-v2-'+slot" :value="slot">{{ slot }}</option></select></template></div></div> </div><div v-if="newCourse.isVacation && newCourse.time === '全天' && !isEditing" class="animate-in fade-in slide-in-from-top-2 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"> <label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left text-left text-left text-left text-left text-left text-left">結束日期</label><input v-model="newCourse.endDate" type="date" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left text-left text-left text-left text-left text-left text-left" :min="newCourse.date"> </div><button @click="saveCourse" class="w-full text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition-all text-center bg-slate-900 text-center text-center text-center text-center text-center text-center text-center text-center text-center">確定儲存同步</button></div></div></div></transition>

        <!-- 學員編輯 -->
        <transition name="fade"><div v-if="showStudentModal" class="fixed inset-0 z-[600] flex items-center justify-center p-2 text-left text-left text-left"><div @click="showStudentModal = false" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm text-left text-left text-left"></div><div class="relative w-full max-w-md bg-white rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 text-left text-left text-left text-left text-left text-left text-left"><div class="flex items-center justify-between mb-6 text-left text-left text-left text-left text-left"><div><h3 class="text-xl font-black text-slate-900 text-left text-left text-left text-left">編輯學員</h3></div><button @click="showStudentModal = false" class="p-2 bg-slate-100 rounded-full active:scale-95 text-left text-left text-left text-left text-left text-left text-left"> <i data-lucide="x" class="w-6 h-6 text-left text-left"></i> </button></div><div class="space-y-4 text-left text-left text-left text-left text-left"><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left">姓名</label><input v-model="currentStudent.name" type="text" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left text-left"></div><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left">學生類型</label><input v-model="currentStudent.studentType" type="text" placeholder="例如：正式生" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left text-left"></div><div><label class="text-[10px] font-black text-slate-400 mb-1 block uppercase text-left text-left text-left">總堂數</label><input v-model.number="currentStudent.totalLessons" type="number" class="w-full bg-slate-100 border-none rounded-xl py-4 px-5 font-black text-base text-left text-left text-left text-left"></div><button @click="saveStudent" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition-all text-center text-center text-center text-center text-center text-center">確認存檔</button></div></div></div></transition>

        <!-- 預約確認 -->
        <transition name="fade"><div v-if="showBookingModal" class="fixed inset-0 z-[600] flex items-end md:items-center justify-center p-0 md:p-6 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><div @click="showBookingModal = false" class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm text-left text-left text-left text-left text-left text-left text-left text-left"></div><div class="relative w-full max-w-xl bg-white rounded-t-[2.5rem] md:rounded-[3.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom-10 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><div class="flex items-center justify-between mb-6 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><div class="text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><h3 class="text-2xl font-black text-slate-900 leading-tight">預約確認</h3><p class="text-indigo-600 font-black mt-1 text-sm">時間：{{ selectedSlot }} ({{ bookingDateLabel }})</p></div><button @click="showBookingModal = false" class="p-2 bg-slate-50 rounded-full active:scale-95 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"> <i data-lucide="x" class="w-7 h-7 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"></i> </button></div><div class="space-y-8 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><div><label class="block text-[10px] font-black text-slate-400 uppercase mb-2 pl-1 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left">您的姓名</label><input v-model="bookingName" type="text" placeholder="請輸入姓名" class="w-full bg-slate-50 border-none rounded-2xl py-6 px-8 focus:ring-4 focus:ring-indigo-100 font-black text-xl text-slate-800 text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"></div><button @click="confirmBooking" class="w-full bg-slate-900 text-white font-black py-6 rounded-3xl active:scale-95 transition-all text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center">完成預約</button></div></div></div></transition>

        <!-- 出席明細 -->
        <transition name="fade"><div v-if="showAttendanceModal" class="fixed inset-0 z-[700] flex items-center justify-center p-4 text-left"><div @click="showAttendanceModal = false" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm text-left"></div><div class="relative w-full max-w-md bg-white rounded-[3rem] p-8 shadow-2xl animate-in zoom-in-95 text-left text-left text-left"><div class="flex items-center justify-between mb-6 text-left"><div><h3 class="text-2xl font-black text-slate-900">出席明細</h3><p class="text-indigo-600 font-bold mt-1 text-sm">學員：{{ selectedStudentForAttendance?.name }}</p></div><button @click="showAttendanceModal = false" class="p-2 bg-slate-100 rounded-full active:scale-95 text-left"> <i data-lucide="x" class="w-6 h-6"></i> </button></div><div class="max-h-[60vh] overflow-y-auto custom-scrollbar pr-2 text-left"><div v-for="record in getStudentRecords(selectedStudentForAttendance?.name)" :key="'att-f-final-'+record.id" class="attendance-record-item"><div class="flex flex-col text-left"><span class="font-black text-sm text-slate-700">{{ record.date }}</span><span class="text-xs font-bold text-slate-400">{{ record.time }}</span></div><span :class="['status-badge-small border text-left', record.status === 'confirmed' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-amber-50 text-amber-600 border-amber-100']">{{ record.status === 'confirmed' ? '已出席' : '未出席' }}</span></div><div v-if="getStudentRecords(selectedStudentForAttendance?.name).length === 0" class="text-center py-20 text-slate-300 font-black italic">尚無紀錄</div></div></div></div></transition>

        <!-- 備忘錄彈窗 (修正標籤與點擊反應) -->
        <transition name="fade"><div v-if="showNoteModal" class="fixed inset-0 z-[650] flex items-center justify-center p-4 text-left"><div @click="showNoteModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm text-left"></div><div class="relative w-full max-sm bg-white rounded-[2rem] p-6 shadow-2xl animate-in zoom-in-95 text-left"><div class="flex items-center justify-between mb-4 text-left"><div><h3 class="text-lg font-black text-slate-900">新增紀錄</h3><p class="text-[9px] font-bold text-slate-400 mt-1">對象：{{ tempLeadForNote?.name }}</p></div><button @click="showNoteModal = false" class="p-1.5 text-slate-400 hover:bg-slate-50 rounded-full text-left"> <i data-lucide="x" class="w-5 h-5"></i> </button></div><div class="space-y-4 text-left"><div><label class="text-[10px] font-black text-slate-400 mb-2 block">內容細節</label><textarea v-model="tempNoteContent" placeholder="記錄聯繫狀況..." class="w-full h-32 bg-slate-50 border-none rounded-xl py-3 px-4 font-bold text-slate-800 resize-none"></textarea></div><button @click="submitNote" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-all text-center">確定存檔</button></div></div></div></transition>

        <!-- Toast -->
        <div v-if="toast.show" class="fixed top-12 left-1/2 -translate-x-1/2 z-[2100] bg-slate-900 text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-3 animate-in fade-in slide-in-from-top-10 text-left text-left"><i data-lucide="check-circle" class="w-5 h-5 text-emerald-400 text-left"></i><span class="text-sm font-black text-left">{{ toast.msg }}</span></div>
    </div>

    <!-- 腳本整合 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, updateDoc, deleteDoc, addDoc, writeBatch, enableNetwork, disableNetwork, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYd3TMHBbDzi0r2zT56ad0qWQvq-1EXpw",
            authDomain: "wei-s-34bb6.firebaseapp.com",
            projectId: "wei-s-34bb6",
            storageBucket: "wei-s-34bb6.firebasestorage.app",
            messagingSenderId: "701108798769",
            appId: "1:701108798769:web:1d3878d12ea7eb57969c10",
            measurementId: "G-32YEEVCB9X"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const appId = 'coach-live-sync-v1';

        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // --- 1. 核心常量陣列 (必須置頂宣告) ---
                const monthLabelsArr = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
                const dayNamesShort = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                const availableSlotsRaw = Array.from({length: 31}, (_, i) => { const h = Math.floor(i / 2) + 7; const m = (i % 2) * 30; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; });

                // --- 2. 響應式狀態 (Refs) ---
                const courses = ref([]);
                const students = ref([]);
                const leads = ref([]);
                const user = ref(null);
                const isCoachMode = ref(false);
                const activeTab = ref('booking');
                const calendarView = ref('week');
                const viewDate = ref(new Date()); 
                const selectedYear = ref(new Date().getFullYear());
                const selectedMonth = ref(new Date().getMonth());
                const selectedDate = ref(""); 
                const syncStatus = ref('synced');
                const toast = ref({ show: false, msg: '' });
                const isEditing = ref(false);
                const isEditingStudent = ref(false);
                const isEditingLead = ref(false);
                const studentViewMode = ref('active');
                const leadViewMode = ref('active');
                
                const showAddModal = ref(false);
                const showStudentModal = ref(false);
                const showCoachAuth = ref(false);
                const showLeadModal = ref(false);
                const showNoteModal = ref(false);
                const showBookingModal = ref(false); 
                const showAttendanceModal = ref(false);
                const showDeleteModal = ref(false);
                const deleteTargetName = ref('');
                const deleteCallback = ref(null);

                const coachPass = ref('');
                const bookingName = ref('');
                const selectedSlot = ref('');
                const touchStartX = ref(0);
                const selectedStudentForAttendance = ref(null);

                const newCourse = ref({ title: '', date: '', endDate: '', time: '全天', endTime: '', student: '', isVacation: false, isWorkTask: false, status: 'confirmed' });
                const currentStudent = ref({ name: '', totalLessons: 10, isArchived: false, studentType: '' });
                const currentLead = ref({ name: '', phone: '', lineMsg: '', status: '待聯繫', notes: [], purchasedLessons: 10, isCompleted: false });
                const tempLeadForNote = ref(null);
                const tempNoteContent = ref('');

                // --- 3. 工具與查詢函數 ---
                const formatDateLocal = (d) => { if (!d) return ""; const year = d.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; };
                const todayDateStr = ref(formatDateLocal(new Date()));
                const toMin = (t) => { if(!t || t === '全天') return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; };
                const refreshIcons = () => { nextTick(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }); };
                const showToast = (m) => { toast.value = { show: true, msg: m }; setTimeout(() => toast.value.show = false, 3000); };
                const getEndTime = (s) => { if (!s || s === '全天') return ''; const [h, m] = s.split(':').map(Number); const t = h * 60 + m + 60; return `${Math.floor(t/60).toString().padStart(2,'0')}:${(t%60).toString().padStart(2,'0')}`; };
                const bookingTimeDisplay = (t) => { if (!t || t === '全天') return '全天休假'; return `${t} - ${getEndTime(t)}`; };
                const getLightBgClass = (color) => color ? `${color.split('-')[0]}-${color.split('-')[1]}-50` : 'bg-indigo-50';
                const getBorderClass = (color) => color ? color.replace('bg-', 'border-') : 'border-indigo-500';
                const getLeadStatusClass = (status) => { switch(status) { case '待聯繫': return 'bg-amber-100 text-amber-600'; case '聯繫中': return 'bg-indigo-100 text-indigo-600'; case '體驗': case '已約體驗': return 'bg-purple-100 text-purple-600'; case '成功': case '開發成功': case '已開發成功': return 'bg-emerald-100 text-emerald-600'; default: return 'bg-slate-100 text-slate-400'; } };

                const scheduleSortLogic = (a, b) => {
                    const today = todayDateStr.value;
                    const getR = (d) => d === today ? 1 : (d > today ? 2 : 3);
                    const rA = getR(a.date); const rB = getR(b.date);
                    if (rA !== rB) return rA - rB;
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return (a.time || '').localeCompare(b.time || '');
                };

                const getDayCourses = (date) => (courses.value || []).filter(c => c.date === date).sort((a,b) => (a.time||'').localeCompare(b.time||''));
                const isFullDayVacation = (date) => (courses.value || []).some(c => c.date === date && c.isVacation && c.time === '全天');
                
                const getAvailableSlots = (date) => {
                    if (!date || isFullDayVacation(date)) return [];
                    const dayCourses = courses.value.filter(c => c.date === date && c.status !== 'cancelled');
                    if (dayCourses.some(c => c.time === '全天')) return [];
                    return availableSlotsRaw.filter(slot => {
                        const slotMin = toMin(slot);
                        return !dayCourses.some(c => c.time !== '全天' && Math.abs(slotMin - toMin(c.time)) < 60);
                    });
                };

                const getStudentStats = (name) => { 
                    if (!name) return { used: 0, remaining: 0, rate: 0 };
                    const used = courses.value.filter(c => c?.student?.trim() === name.trim() && !c?.isVacation && !c?.isWorkTask && (c?.status === 'confirmed' || c?.status === 'no-show')).length; 
                    const sObj = students.value.find(s => s?.name?.trim() === name.trim()); 
                    const total = (sObj ? (sObj.totalLessons || 0) : 0);
                    return { used, remaining: total - used, rate: total > 0 ? Math.round((used / total) * 100) : 0 }; 
                };

                const getStudentRecords = (name) => {
                    if (!name) return [];
                    return courses.value
                        .filter(c => c?.student?.trim() === name.trim() && !c?.isVacation && !c?.isWorkTask && (c?.status === 'confirmed' || c?.status === 'no-show'))
                        .sort((a,b) => b.date.localeCompare(a.date))
                        .map(c => ({ id: c.id, date: c.date, time: c.time, status: c.status }));
                };

                // --- 4. 計算屬性 ---
                const currentWeekDays = computed(() => {
                    const days = []; const base = new Date(viewDate.value);
                    const sun = new Date(base); sun.setDate(base.getDate() - base.getDay());
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(sun); d.setDate(sun.getDate() + i); const ds = formatDateLocal(d);
                        days.push({ name: dayNamesShort[d.getDay()], dayNum: d.getDate(), date: ds, isToday: ds === todayDateStr.value });
                    } return days;
                });

                const monthlyFullSchedule = computed(() => (courses.value || []).filter(c => c.date && c.date.startsWith(`${selectedYear.value}-${(selectedMonth.value + 1).toString().padStart(2, '0')}`)).sort(scheduleSortLogic));
                const weeklyFullSchedule = computed(() => { const dates = currentWeekDays.value.map(d => d.date); return (courses.value || []).filter(c => dates.includes(c.date)).sort(scheduleSortLogic); });
                const upcomingSchedule = computed(() => (courses.value || []).filter(c => c.date).sort(scheduleSortLogic));
                const activeLeads = computed(() => (leads.value || []).filter(l => l.status !== '已開發成功' && l.status !== '成功' && l.status !== '開發成功' && l.status !== '已結案'));
                const archivedLeads = computed(() => (leads.value || []).filter(l => l.status === '已開發成功' || l.status === '成功' || l.status === '開發成功' || l.status === '已結案'));
                const activeStudents = computed(() => (students.value || []).filter(s => !s.isArchived));
                const archivedStudents = computed(() => (students.value || []).filter(s => s.isArchived));
                const yearOptions = computed(() => { const curr = new Date().getFullYear(); return [curr - 1, curr, curr + 1, curr + 2]; });

                // --- 5. 動作 Action 函數 ---
                const goToToday = () => { const t = new Date(); viewDate.value = t; selectedYear.value = t.getFullYear(); selectedMonth.value = t.getMonth(); selectedDate.value = formatDateLocal(t); refreshIcons(); };
                const changeViewPeriod = (v) => {
                    const d = new Date(viewDate.value);
                    if (activeTab.value === 'booking' || (isCoachMode.value && calendarView.value === 'week')) { d.setDate(d.getDate() + v * 7); } 
                    else { d.setDate(1); d.setMonth(d.getMonth() + v); }
                    viewDate.value = d; selectedYear.value = d.getFullYear(); selectedMonth.value = d.getMonth(); refreshIcons();
                };

                const verifyCoach = () => { if (coachPass.value === '888') { isCoachMode.value = true; activeTab.value = 'schedule'; calendarView.value = 'week'; goToToday(); showCoachAuth.value = false; coachPass.value = ''; showToast('驗證成功'); } else { showToast('密碼錯誤'); } };
                const logoutCoach = () => { isCoachMode.value = false; activeTab.value = 'booking'; showToast('已登出'); };
                const manualSync = async () => { syncStatus.value = 'syncing'; await disableNetwork(db); await enableNetwork(db); setTimeout(() => { syncStatus.value = 'synced'; refreshIcons(); }, 500); };

                const confirmDeleteAction = (name, callback) => { deleteTargetName.value = name; deleteCallback.value = callback; showDeleteModal.value = true; refreshIcons(); };
                const executeDelete = async () => { if (deleteCallback.value) await deleteCallback.value(); showDeleteModal.value = false; refreshIcons(); };

                const deleteCourse = (id) => confirmDeleteAction('行程', async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', id)); showToast('已刪除'); });
                const deleteStudent = (id) => confirmDeleteAction('學員', async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id)); showToast('已刪除'); });
                const deleteLead = (id) => confirmDeleteAction('開發對象', async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', id)); showToast('已刪除'); });

                const triggerBooking = (slot, date) => { selectedSlot.value = slot; selectedDate.value = date; bookingName.value = ''; showBookingModal.value = true; refreshIcons(); };
                const confirmBooking = async () => { if (!bookingName.value) return showToast('姓名必填'); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'courses'), { student: bookingName.value.trim(), date: selectedDate.value, time: selectedSlot.value, isVacation: false, isWorkTask: false, status: 'confirmed', color: 'bg-indigo-50' }); showBookingModal.value = false; showToast('預約成功'); refreshIcons(); };

                const openAddModal = () => { isEditing.value = false; newCourse.value = { title: '', date: selectedDate.value || formatDateLocal(new Date()), endDate: '', time: '全天', endTime: '', student: '', isVacation: false, isWorkTask: false, status: 'confirmed' }; showAddModal.value = true; refreshIcons(); };
                const editCourse = (c) => { isEditing.value = true; newCourse.value = { ...c }; showAddModal.value = true; refreshIcons(); };
                
                const openStudentModal = () => { isEditingStudent.value = false; currentStudent.value = { name: '', totalLessons: 10, isArchived: false, studentType: '' }; showStudentModal.value = true; refreshIcons(); };
                const editStudent = (s) => { isEditingStudent.value = true; currentStudent.value = { ...s }; showStudentModal.value = true; refreshIcons(); };
                const openLeadModal = () => { isEditingLead.value = false; currentLead.value = { name: '', phone: '', lineMsg: '', status: '待聯繫', notes: [], purchasedLessons: 10, isCompleted: false }; showLeadModal.value = true; refreshIcons(); };
                const editLead = (l) => { isEditingLead.value = true; currentLead.value = { ...l }; showLeadModal.value = true; refreshIcons(); };

                const saveCourse = async () => { 
                    if (!newCourse.value.student && !newCourse.value.isVacation) return showToast('內容必填'); 
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'courses');
                    if (newCourse.value.isVacation && newCourse.value.time === '全天' && newCourse.value.endDate && newCourse.value.endDate !== newCourse.value.date) {
                        const start = new Date(newCourse.value.date); const end = new Date(newCourse.value.endDate);
                        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) { await addDoc(col, { student: '休假', date: formatDateLocal(d), time: '全天', isVacation: true, isWorkTask: false, status: 'confirmed' }); }
                    } else if (newCourse.value.time !== '全天' && newCourse.value.endTime) {
                        const startMin = toMin(newCourse.value.time); const endMin = toMin(newCourse.value.endTime);
                        for (let m = startMin; m < endMin; m += 60) {
                            const hh = Math.floor(m / 60).toString().padStart(2, '0'); const mm = (m % 60).toString().padStart(2, '0');
                            await addDoc(col, { ...newCourse.value, time: `${hh}:${mm}` });
                        }
                    } else {
                        if (isEditing.value) { const dId = newCourse.value.id; const data = { ...newCourse.value }; delete data.id; await updateDoc(doc(db, col.path, dId), data); }
                        else { await addDoc(col, { ...newCourse.value }); }
                    }
                    showAddModal.value = false; showToast('行程存檔完成'); refreshIcons();
                };

                const saveStudent = async () => { if (!currentStudent.value.name) return; const col = collection(db, 'artifacts', appId, 'public', 'data', 'students'); if (isEditingStudent.value) { const sid = currentStudent.value.id; const data = {...currentStudent.value}; delete data.id; await updateDoc(doc(db, col.path, sid), data); } else { await addDoc(col, { ...currentStudent.value, isArchived: false }); } showStudentModal.value = false; showToast('學員已儲存'); refreshIcons(); };
                
                const saveLead = async () => { 
                    if (!currentLead.value.name) return; 
                    const colLeads = collection(db, 'artifacts', appId, 'public', 'data', 'leads'); 
                    const colStudents = collection(db, 'artifacts', appId, 'public', 'data', 'students');
                    const finalStatus = (currentLead.value.status === '成功' || currentLead.value.status === '開發成功' || currentLead.value.status === '已開發成功') ? '已開發成功' : currentLead.value.status;
                    
                    if (finalStatus === '已開發成功') {
                        const exists = students.value.some(s => s.name === currentLead.value.name);
                        if (!exists) { await addDoc(colStudents, { name: currentLead.value.name, totalLessons: currentLead.value.purchasedLessons || 10, source: '開發成功轉入', isArchived: false, studentType: '正式生' }); }
                    } else {
                        const targetStudent = students.value.find(s => s.name === currentLead.value.name && s.source === '開發成功轉入');
                        if (targetStudent) { await deleteDoc(doc(db, colStudents.path, targetStudent.id)); }
                    }

                    if (isEditingLead.value) { const lid = currentLead.value.id; const data = { ...currentLead.value, status: finalStatus }; delete data.id; await updateDoc(doc(db, colLeads.path, lid), data); } 
                    else { await addDoc(colLeads, { ...currentLead.value, status: finalStatus, createdAt: new Date().toISOString() }); } 
                    showLeadModal.value = false; showToast('開發狀態已同步'); refreshIcons();
                };

                const triggerLeadStatusUpdate = async (lead, st) => {
                    const normalizedSt = st === '體驗' ? '已約體驗' : (st === '成功' || st === '開發成功') ? '開發成功' : st;
                    const colStudents = collection(db, 'artifacts', appId, 'public', 'data', 'students');
                    
                    if (normalizedSt === '開發成功') {
                        editLead(lead); 
                        currentLead.value.status = '已開發成功';
                    } else {
                        if (lead.status === '已開發成功' || lead.status === '開發成功') {
                            const targetStudent = students.value.find(s => s.name === lead.name && s.source === '開發成功轉入');
                            if (targetStudent) { await deleteDoc(doc(db, colStudents.path, targetStudent.id)); }
                        }
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', lead.id), { status: normalizedSt }); 
                        showToast('進度更新');
                    }
                };

                const addProgressNote = (lead) => { if (!lead?.id) return; tempLeadForNote.value = { ...lead }; tempNoteContent.value = ''; showNoteModal.value = true; refreshIcons(); };
                const submitNote = async () => { if (!tempNoteContent.value || !tempLeadForNote.value?.id) return; const ex = leads.value.find(l => l.id === tempLeadForNote.value.id)?.notes || []; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', tempLeadForNote.value.id), { notes: [...ex, { content: tempNoteContent.value, date: new Date().toLocaleString() }] }); showNoteModal.value = false; showToast('紀錄同步完成'); refreshIcons(); };
                const openAttendanceDetail = (s) => { selectedStudentForAttendance.value = s; showAttendanceModal.value = true; refreshIcons(); };
                const renewStudent = async (s) => { if (!s.renewalLessons || s.renewalLessons <= 0) return; const newT = (s.totalLessons || 0) + s.renewalLessons; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id), { totalLessons: newT, isArchived: false }); showToast('續約成功'); };
                const archiveStudent = async (id, arc) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), { isArchived: arc }); showToast(arc ? '封存成功' : '恢復成功'); };
                const updateCourseStatus = async (id, st) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', id), { status: st }); showToast('出席更新完成'); };
                const toggleLeadComplete = async (lead) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', lead.id), { isCompleted: !lead.isCompleted }); };

                const handleTouchStart = (e) => { touchStartX.value = e.changedTouches[0].screenX; };
                const handleTouchEnd = (e) => { const diff = e.changedTouches[0].screenX - touchStartX.value; if (Math.abs(diff) > 50) { changeViewPeriod(diff > 0 ? -1 : 1); } };

                // --- 6. 監聽與初始化 ---
                watch([courses, students, leads, activeTab, calendarView, studentViewMode, leadViewMode, showAddModal, showStudentModal, showLeadModal, showNoteModal, showBookingModal, showAttendanceModal, showDeleteModal], () => {
                    refreshIcons();
                }, { flush: 'post', deep: true });

                onMounted(async () => {
                    try {
                        const now = new Date(); viewDate.value = now; selectedYear.value = now.getFullYear(); selectedMonth.value = now.getMonth(); selectedDate.value = formatDateLocal(now);
                        await signInAnonymously(auth);
                        onAuthStateChanged(auth, (u) => {
                            user.value = u;
                            if (u) {
                                ['courses', 'students', 'leads'].forEach(name => {
                                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', name), (snap) => {
                                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                        if (name === 'courses') courses.value = data;
                                        else if (name === 'students') students.value = data;
                                        else if (name === 'leads') leads.value = data;
                                        syncStatus.value = 'synced';
                                    });
                                });
                            }
                        });
                    } catch (e) { console.error("Init fail:", e); }
                });

                return {
                    user, syncStatus, activeTab, navItems: [{ id: 'schedule', name: '課程表', icon: 'calendar' }, { id: 'students', name: '學員名單', icon: 'users' }, { id: 'leads', name: '開發進度', icon: 'message-square' }, { id: 'booking', name: '預約端', icon: 'send' }], 
                    courses, students, leads, isCoachMode, calendarView, selectedDate, getDayCourses, weekRangeLabel: computed(() => currentWeekDays.value.length ? `${currentWeekDays.value[0].date} - ${currentWeekDays.value[6].date}` : ''), viewMonthPadding: computed(() => Array.from({ length: new Date(viewDate.value.getFullYear(), viewDate.value.getMonth(), 1).getDay() }, (_, i) => i)), viewDaysInMonth: computed(() => Array.from({length: new Date(viewDate.value.getFullYear(), viewDate.value.getMonth()+1, 0).getDate()}, (_, i) => ({ dayNum: i+1, date: formatDateLocal(new Date(viewDate.value.getFullYear(), viewDate.value.getMonth(), i+1)), isToday: formatDateLocal(new Date(viewDate.value.getFullYear(), viewDate.value.getMonth(), i+1)) === todayDateStr.value }))), showAddModal, showStudentModal, showCoachAuth, showLeadModal, showNoteModal, showAttendanceModal, showBookingModal, showDeleteModal, deleteTargetName, selectedStudentForAttendance, coachPass, bookingName, bookingDateLabel: computed(() => selectedDate.value), selectedSlot, verifyCoach, logoutCoach, manualSync, openAddModal, editCourse, saveCourse, saveStudent, saveLead, updateCourseStatus, deleteCourse, deleteStudent, deleteLead, executeDelete, toast, getAvailableSlots, bookingTimeDisplay, isFullDayVacation, goToToday, getStudentStats, getStudentRecords, currentWeekDays, dayNamesShort, monthlyFullSchedule, weeklyFullSchedule, upcomingSchedule, openStudentModal, editStudent, yearOptions, monthLabelsArr, selectedYear, selectedMonth, newCourse, currentStudent, currentLead, openLeadModal, editLead, addProgressNote, submitNote, getLightBgClass, getBorderClass, getLeadStatusClass, toggleLeadComplete, isEditing, isEditingStudent, isEditingLead, triggerLeadStatusUpdate, availableSlotsRaw, studentViewMode, leadViewMode, activeLeads, archivedLeads, activeStudents, archivedStudents, renewStudent, archiveStudent, openAttendanceDetail, triggerBooking, confirmBooking, changeViewPeriod, handleTouchStart, handleTouchEnd, todayDateStr, pageTitle: computed(() => { switch(activeTab.value) { case 'schedule': return '排程管理'; case 'students': return '學員名單'; case 'leads': return '開發對象'; default: return '教練管理系統'; } }), toMin
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
